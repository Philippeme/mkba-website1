{{ form_start(form, {'attr': {'id': 'procedureForm', 'enctype': 'multipart/form-data'}}) }}
<div class="row">
    <div class="col-md-8">
        <div class="mb-3">
            {{ form_row(form.pname, {
                'label_attr': {'class': 'form-label fw-bold'},
                'attr': {'class': 'form-control'}
            }) }}
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    {{ form_row(form.family, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-select'}
                    }) }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    {{ form_row(form.providingAdministration, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-select', 'onchange': 'updateAdministrationInfo(this)'}
                    }) }}
                    <div class="form-text">
                        <small><i class="bi-info-circle me-1"></i>Select the government institution responsible for this procedure</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            {{ form_row(form.shortdesc, {
                'label_attr': {'class': 'form-label fw-bold'},
                'attr': {'class': 'form-control', 'rows': 3}
            }) }}
        </div>
        
        <div class="mb-3">
            {{ form_row(form.longdesc, {
                'label_attr': {'class': 'form-label fw-bold'},
                'attr': {'class': 'form-control', 'rows': 6}
            }) }}
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    {{ form_row(form.processtime, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-control'}
                    }) }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    {{ form_row(form.servicecost, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-control'}
                    }) }}
                </div>
            </div>
        </div>

        <!-- NEW: Documents Association Section -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="bi-files me-2"></i>
                    Associated Documents
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info border-0 mb-3">
                    <div class="d-flex align-items-start">
                        <i class="bi-info-circle me-2 mt-1"></i>
                        <div>
                            <small>
                                <strong>Document Association:</strong> Select documents that are part of this procedure. 
                                Documents can be input documents (required from citizens) or output documents (generated by the system).
                                Use Ctrl+Click to select multiple documents.
                            </small>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    {{ form_row(form.documents, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {
                            'class': 'form-select',
                            'multiple': true,
                            'size': 8,
                            'onchange': 'updateDocumentPreview()',
                            'data-bs-toggle': 'tooltip',
                            'title': 'Hold Ctrl/Cmd while clicking to select multiple documents'
                        }
                    }) }}
                </div>

                <!-- Document Preview Section -->
                <div id="documentPreviewSection" class="mt-3">
                    <h6 class="fw-bold text-muted mb-2">
                        <i class="bi-eye me-1"></i>Selected Documents Preview
                    </h6>
                    <div id="selectedDocumentsPreview" class="border rounded p-3 bg-light">
                        {% if procedure.documents and procedure.documents|length > 0 %}
                            <div class="row">
                                <div class="col-md-6">
                                    <strong class="text-warning small d-block mb-2">
                                        <i class="bi-arrow-down-circle me-1"></i>Input Documents ({{ procedure.inputDocuments|length }})
                                    </strong>
                                    {% for document in procedure.inputDocuments %}
                                        <div class="document-item mb-1 p-2 border rounded bg-white">
                                            <div class="d-flex align-items-center">
                                                <i class="bi-file-earmark text-warning me-2"></i>
                                                <div class="flex-grow-1">
                                                    <small class="fw-bold">{{ document.name }}</small>
                                                    {% if document.isRequired %}
                                                        <span class="badge bg-danger badge-sm ms-1">Required</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary badge-sm ms-1">Optional</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    {% if procedure.inputDocuments|length == 0 %}
                                        <small class="text-muted">No input documents</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <strong class="text-success small d-block mb-2">
                                        <i class="bi-arrow-up-circle me-1"></i>Output Documents ({{ procedure.outputDocuments|length }})
                                    </strong>
                                    {% for document in procedure.outputDocuments %}
                                        <div class="document-item mb-1 p-2 border rounded bg-white">
                                            <div class="d-flex align-items-center">
                                                <i class="bi-file-earmark text-success me-2"></i>
                                                <div class="flex-grow-1">
                                                    <small class="fw-bold">{{ document.name }}</small>
                                                    <div class="text-muted small">{{ document.description|slice(0, 30) }}{% if document.description|length > 30 %}...{% endif %}</div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    {% if procedure.outputDocuments|length == 0 %}
                                        <small class="text-muted">No output documents</small>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="bi-files" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">No documents selected</p>
                                <small>Select documents from the list above to see the preview</small>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="mt-3">
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" onclick="selectAllDocuments('input')">
                            <i class="bi-check-all me-1"></i>Select All Input
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="selectAllDocuments('output')">
                            <i class="bi-check-all me-1"></i>Select All Output
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearDocumentSelection()">
                            <i class="bi-x-circle me-1"></i>Clear Selection
                        </button>
                        <a href="{{ path('admin_document_new') }}?procedure={{ procedure.id }}" 
                           class="btn btn-outline-info" 
                           target="_blank">
                            <i class="bi-plus-circle me-1"></i>Create New Document
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    {{ form_row(form.displayOrder, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-control'}
                    }) }}
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <div class="form-check form-switch mt-4">
                        {{ form_widget(form.published, {'attr': {'class': 'form-check-input'}}) }}
                        {{ form_label(form.published, 'Published', {'label_attr': {'class': 'form-check-label fw-bold'}}) }}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <div class="form-check form-switch mt-4">
                        {{ form_widget(form.isActive, {'attr': {'class': 'form-check-input'}}) }}
                        {{ form_label(form.isActive, 'Active Status', {'label_attr': {'class': 'form-check-label fw-bold'}}) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Image Section -->
        <div class="card bg-light mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi-image me-2"></i>
                    Procedure Image
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3 text-center">
                    <div id="imagePreview" class="border rounded p-3" style="min-height: 120px;">
                        {% if procedure.image %}
                            <img src="{{ asset('uploads/procedures/' ~ procedure.image) }}" 
                                 alt="{{ procedure.pname }}" 
                                 class="img-fluid rounded"
                                 style="max-height: 100px;">
                            <p class="mt-2 mb-0 small text-muted">Current Image</p>
                        {% else %}
                            <div class="text-muted">
                                <i class="bi-image" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">No image selected</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    {{ form_row(form.imageBootstrap, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-select', 'onchange': 'updateImagePreview(this.value, this.options[this.selectedIndex].text)'}
                    }) }}
                </div>
                
                <div class="mb-3">
                    {{ form_row(form.imageFile, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-control', 'accept': 'image/*', 'onchange': 'previewImage(this)'}
                    }) }}
                </div>

                <!-- Remove Image Option -->
                <div class="mb-3">
                    <div class="form-check">
                        {{ form_widget(form.removeImage, {'attr': {'class': 'form-check-input'}}) }}
                        {{ form_label(form.removeImage, 'Remove current image', {'label_attr': {'class': 'form-check-label text-danger'}}) }}
                    </div>
                </div>
                
                <div class="form-text">
                    <small>
                        <i class="bi-info-circle me-1"></i>
                        Choose template or upload custom. Max: 5MB
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Legal Document Section -->
        <div class="card bg-light mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi-file-pdf me-2"></i>
                    Legal Document
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3 text-center">
                    <div id="documentPreview" class="border rounded p-3" style="min-height: 80px;">
                        {% if procedure.legaltext %}
                            <div class="text-success">
                                <i class="bi-file-pdf" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">
                                    <a href="{{ asset('uploads/documents/' ~ procedure.legaltext) }}" 
                                       target="_blank" 
                                       class="text-decoration-none">
                                        View Current Document
                                    </a>
                                </p>
                            </div>
                        {% else %}
                            <div class="text-muted">
                                <i class="bi-file-pdf" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">No document selected</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    {{ form_row(form.legalTextTemplate, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-select', 'onchange': 'updateLegalTextPreview(this.value, this.options[this.selectedIndex].text)'}
                    }) }}
                </div>
                
                <div class="mb-3">
                    {{ form_row(form.legalTextFile, {
                        'label_attr': {'class': 'form-label fw-bold'},
                        'attr': {'class': 'form-control', 'accept': '.pdf', 'onchange': 'previewDocument(this)'}
                    }) }}
                </div>

                <!-- Remove Legal Document Option -->
                <div class="mb-3">
                    <div class="form-check">
                        {{ form_widget(form.removeLegalText, {'attr': {'class': 'form-check-input'}}) }}
                        {{ form_label(form.removeLegalText, 'Remove current document', {'label_attr': {'class': 'form-check-label text-danger'}}) }}
                    </div>
                </div>
                
                <div class="form-text">
                    <small>
                        <i class="bi-info-circle me-1"></i>
                        Choose template or upload custom. Max: 10MB (PDF)
                    </small>
                </div>
            </div>
        </div>

        <!-- Administration Info Card -->
        <div class="card bg-light mb-3" id="administrationInfoCard" style="display: none;">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi-building me-2"></i>
                    Administration Info
                </h6>
            </div>
            <div class="card-body" id="administrationInfo">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Workflow Management Section -->
        {% if procedure.id %}
        <div class="card bg-light">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="bi-diagram-3 me-2"></i>
                    Workflow Steps ({{ procedure.workflowCount }})
                </h6>
                <div class="btn-group btn-group-sm">
                    <a href="{{ path('admin_workflow_new', {'procedure': procedure.id}) }}" class="btn btn-success">
                        <i class="bi-plus-circle me-1"></i>Add
                    </a>
                    {% if procedure.hasWorkflows %}
                    <a href="{{ path('admin_workflow_by_procedure', {'id': procedure.id}) }}" class="btn btn-outline-primary">
                        <i class="bi-eye me-1"></i>View All
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if procedure.hasWorkflows %}
                    <!-- Workflow Steps List -->
                    <div class="workflow-steps-list">
                        {% for workflow in procedure.activeWorkflows|slice(0, 3) %}
                        <div class="workflow-step-item border rounded p-2 mb-2 bg-white">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-primary me-2">{{ workflow.stepOrder }}</span>
                                    <div>
                                        <strong class="small">{{ workflow.name }}</strong>
                                        <div class="text-muted small">{{ workflow.shortDescription|slice(0, 50) }}{% if workflow.shortDescription|length > 50 %}...{% endif %}</div>
                                        <div class="mt-1">
                                            {% if workflow.isRequired %}
                                                <span class="badge bg-warning badge-sm">Required</span>
                                            {% else %}
                                                <span class="badge bg-info badge-sm">Optional</span>
                                            {% endif %}
                                            <span class="badge bg-secondary badge-sm">{{ workflow.inputs|length }} inputs</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ path('admin_workflow_edit', {'id': workflow.id}) }}" 
                                       class="btn btn-outline-warning btn-sm" title="Edit Step">
                                        <i class="bi-pencil"></i>
                                    </a>
                                    <a href="{{ path('admin_workflow_show', {'id': workflow.id}) }}" 
                                       class="btn btn-outline-info btn-sm" title="View Step">
                                        <i class="bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if procedure.workflowCount > 3 %}
                        <div class="text-center mt-3">
                            <a href="{{ path('admin_workflow_by_procedure', {'id': procedure.id}) }}" class="btn btn-outline-primary btn-sm">
                                <i class="bi-list me-1"></i>View All {{ procedure.workflowCount }} Steps
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Workflow Summary -->
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="badge bg-warning fs-6">{{ procedure.requiredWorkflows|length }}</div>
                                <div class="small text-muted">Required Steps</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="badge bg-info fs-6">{{ procedure.optionalWorkflows|length }}</div>
                                <div class="small text-muted">Optional Steps</div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- No Workflow Steps -->
                    <div class="text-center py-3">
                        <i class="bi-diagram-3 text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-2">No workflow steps defined</p>
                        <p class="small text-muted mb-3">Define step-by-step process to help citizens understand requirements</p>
                        <a href="{{ path('admin_workflow_new', {'procedure': procedure.id}) }}" class="btn btn-success btn-sm">
                            <i class="bi-plus-circle me-1"></i>Create First Step
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <!-- Workflow Placeholder for New Procedures -->
        <div class="card bg-light">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi-diagram-3 me-2"></i>
                    Workflow Steps
                </h6>
            </div>
            <div class="card-body text-center">
                <i class="bi-info-circle text-info" style="font-size: 2rem;"></i>
                <p class="text-muted mb-0 mt-2">Save this procedure first to add workflow steps</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <button type="submit" class="btn btn-primary">
        <i class="bi-check-circle me-2"></i>
        {{ button_label|default('Save Procedure') }}
    </button>
    <a href="{{ path('admin_procedure_index') }}" class="btn btn-secondary">
        <i class="bi-arrow-left me-2"></i>
        Cancel
    </a>
    {% if procedure.id %}
    <a href="{{ path('admin_procedure_show', {'id': procedure.id}) }}" class="btn btn-outline-info">
        <i class="bi-file-earmark-text me-2"></i>
        View Procedure
    </a>
    {% if procedure.hasWorkflows %}
    <a href="{{ path('admin_workflow_by_procedure', {'id': procedure.id}) }}" class="btn btn-outline-success">
        <i class="bi-diagram-3 me-2 "></i>
        Manage Workflow
    </a>
    {% endif %}
    {% endif %}
</div>

{{ form_end(form) }}

<script>
// Administration info data (would be populated from controller or Ajax)
const administrationData = {
    {% if procedure.providingAdministration %}
        {{ procedure.providingAdministration.id }}: {
            name: "{{ procedure.providingAdministration.institutionName|e('js') }}",
            department: "{{ procedure.providingAdministration.department ? procedure.providingAdministration.department.name : '' }}",
            address: "{{ procedure.providingAdministration.headquartersAddress|e('js') }}",
            phone: "{{ procedure.providingAdministration.phoneNumber ?? '' }}",
            email: "{{ procedure.providingAdministration.email ?? '' }}",
            website: "{{ procedure.providingAdministration.website ?? '' }}"
        }
    {% endif %}
};

function updateAdministrationInfo(select) {
    const card = document.getElementById('administrationInfoCard');
    const infoDiv = document.getElementById('administrationInfo');
    
    if (select.value && administrationData[select.value]) {
        const data = administrationData[select.value];
        infoDiv.innerHTML = `
            <div class="mb-2">
                <strong class="text-primary">${data.name}</strong>
                ${data.department ? `<div class="small text-muted">Department: ${data.department}</div>` : ''}
            </div>
            <div class="small">
                ${data.address ? `<div><i class="bi-geo-alt me-1"></i>${data.address}</div>` : ''}
                ${data.phone ? `<div><i class="bi-telephone me-1"></i>${data.phone}</div>` : ''}
                ${data.email ? `<div><i class="bi-envelope me-1"></i><a href="mailto:${data.email}">${data.email}</a></div>` : ''}
                ${data.website ? `<div><i class="bi-globe me-1"></i><a href="${data.website}" target="_blank">Website</a></div>` : ''}
            </div>
        `;
        card.style.display = 'block';
    } else {
        card.style.display = 'none';
    }
}

function updateImagePreview(templateValue, templateLabel) {
    if (templateValue) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = `
            <div class="text-primary">
                <i class="bi-card-image" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">Template: ${templateLabel}</p>
                <small class="text-muted">Will be generated automatically</small>
            </div>
        `;
        // Clear custom file input and remove checkbox
        document.querySelector('input[name="procedure[imageFile]"]').value = '';
        const removeCheckbox = document.querySelector('input[name="procedure[removeImage]"]');
        if (removeCheckbox) removeCheckbox.checked = false;
    }
}

function updateLegalTextPreview(templateValue, templateLabel) {
    if (templateValue) {
        const preview = document.getElementById('documentPreview');
        preview.innerHTML = `
            <div class="text-info">
                <i class="bi-file-pdf" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">Template: ${templateLabel}</p>
                <small class="text-muted">Will be generated automatically</small>
            </div>
        `;
        // Clear custom file input and remove checkbox
        document.querySelector('input[name="procedure[legalTextFile]"]').value = '';
        const removeCheckbox = document.querySelector('input[name="procedure[removeLegalText]"]');
        if (removeCheckbox) removeCheckbox.checked = false;
    }
}

function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.innerHTML = `
                <img src="${e.target.result}" 
                     class="img-fluid rounded" 
                     style="max-height: 100px;"
                     alt="Image preview">
                <p class="mt-2 mb-0 small text-muted">Custom Image Preview</p>
            `;
        };
        
        reader.readAsDataURL(input.files[0]);
        
        // Clear template selection and remove checkbox
        document.querySelector('select[name="procedure[imageBootstrap]"]').value = '';
        const removeCheckbox = document.querySelector('input[name="procedure[removeImage]"]');
        if (removeCheckbox) removeCheckbox.checked = false;
    }
}

function previewDocument(input) {
    const preview = document.getElementById('documentPreview');
    
    if (input.files && input.files[0]) {
        const fileName = input.files[0].name;
        const fileSize = (input.files[0].size / 1024 / 1024).toFixed(2);
        
        preview.innerHTML = `
            <div class="text-info">
                <i class="bi-file-pdf" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">${fileName}</p>
                <small class="text-muted">${fileSize} MB</small>
            </div>
        `;
        
        // Clear template selection and remove checkbox
        document.querySelector('select[name="procedure[legalTextTemplate]"]').value = '';
        const removeCheckbox = document.querySelector('input[name="procedure[removeLegalText]"]');
        if (removeCheckbox) removeCheckbox.checked = false;
    }
}

// NEW: Document management functions
function updateDocumentPreview() {
    const documentsSelect = document.querySelector('select[name="procedure[documents][]"]');
    const previewContainer = document.getElementById('selectedDocumentsPreview');
    
    if (!documentsSelect || !previewContainer) return;
    
    const selectedOptions = Array.from(documentsSelect.selectedOptions);
    
    if (selectedOptions.length === 0) {
        previewContainer.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi-files" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">No documents selected</p>
                <small>Select documents from the list above to see the preview</small>
            </div>
        `;
        return;
    }
    
    const inputDocs = [];
    const outputDocs = [];
    
    selectedOptions.forEach(option => {
        const optionText = option.text;
        const docName = optionText.split(' (')[0];
        const docType = optionText.includes('(Input)') ? 'input' : 'output';
        
        if (docType === 'input') {
            inputDocs.push(docName);
        } else {
            outputDocs.push(docName);
        }
    });
    
    previewContainer.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <strong class="text-warning small d-block mb-2">
                    <i class="bi-arrow-down-circle me-1"></i>Input Documents (${inputDocs.length})
                </strong>
                ${inputDocs.length > 0 ? inputDocs.map(doc => `
                    <div class="document-item mb-1 p-2 border rounded bg-white">
                        <div class="d-flex align-items-center">
                            <i class="bi-file-earmark text-warning me-2"></i>
                            <small class="fw-bold">${doc}</small>
                        </div>
                    </div>
                `).join('') : '<small class="text-muted">No input documents</small>'}
            </div>
            <div class="col-md-6">
                <strong class="text-success small d-block mb-2">
                    <i class="bi-arrow-up-circle me-1"></i>Output Documents (${outputDocs.length})
                </strong>
                ${outputDocs.length > 0 ? outputDocs.map(doc => `
                    <div class="document-item mb-1 p-2 border rounded bg-white">
                        <div class="d-flex align-items-center">
                            <i class="bi-file-earmark text-success me-2"></i>
                            <small class="fw-bold">${doc}</small>
                        </div>
                    </div>
                `).join('') : '<small class="text-muted">No output documents</small>'}
            </div>
        </div>
    `;
}

function selectAllDocuments(type) {
    const documentsSelect = document.querySelector('select[name="procedure[documents][]"]');
    if (!documentsSelect) return;
    
    Array.from(documentsSelect.options).forEach(option => {
        if (type === 'input' && option.text.includes('(Input)')) {
            option.selected = true;
        } else if (type === 'output' && option.text.includes('(Output)')) {
            option.selected = true;
        }
    });
    
    updateDocumentPreview();
}

function clearDocumentSelection() {
    const documentsSelect = document.querySelector('select[name="procedure[documents][]"]');
    if (!documentsSelect) return;
    
    Array.from(documentsSelect.options).forEach(option => {
        option.selected = false;
    });
    
    updateDocumentPreview();
}

// Initialize administration info on page load
document.addEventListener('DOMContentLoaded', function() {
    const administrationSelect = document.querySelector('select[name="procedure[providingAdministration]"]');
    if (administrationSelect && administrationSelect.value) {
        updateAdministrationInfo(administrationSelect);
    }
    
    // Initialize document preview
    updateDocumentPreview();
    
    // Add change listener to documents select
    const documentsSelect = document.querySelector('select[name="procedure[documents][]"]');
    if (documentsSelect) {
        documentsSelect.addEventListener('change', updateDocumentPreview);
    }
});

// Form validation
document.getElementById('procedureForm').addEventListener('submit', function(e) {
    const pname = document.querySelector('input[name="procedure[pname]"]').value.trim();
    const family = document.querySelector('select[name="procedure[family]"]').value;
    const shortdesc = document.querySelector('textarea[name="procedure[shortdesc]"]').value.trim();
    const longdesc = document.querySelector('textarea[name="procedure[longdesc]"]').value.trim();
    const processtime = document.querySelector('input[name="procedure[processtime]"]').value.trim();
    const servicecost = document.querySelector('input[name="procedure[servicecost]"]').value.trim();
    
    if (!pname || !family || !shortdesc || !longdesc || !processtime || !servicecost) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return false;
    }
});
</script>

<style>
.workflow-step-item {
    transition: all 0.3s ease;
}

.workflow-step-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.badge-sm {
    font-size: 0.7em;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
}

.document-item {
    transition: all 0.2s ease;
}

.document-item:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
}

#selectedDocumentsPreview {
    max-height: 300px;
    overflow-y: auto;
}
</style>