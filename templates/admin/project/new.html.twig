{% extends 'admin/base.html.twig' %}

{% block title %}Nouveau Projet - MK BA{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --mk-primary: #6d5192;
            --mk-secondary: #8e32e9;
            --mk-orange: #f18221;
            --mk-blue: #0071BC;
            --mk-dark: #1c273c;
            --mk-success: #10b981;
            --mk-warning: #f59e0b;
            --mk-danger: #ef4444;
            --mk-info: #3b82f6;
            --mk-light: #f8f9fa;
            --mk-lighter: #ffffff;
            --mk-gradient-primary: linear-gradient(135deg, #f18221 0%, #0071BC 100%);
        }

        .project-form-header {
            background: var(--mk-gradient-primary);
            color: white;
            padding: 2.5rem 0;
            margin: -2rem -2rem 0 -2rem;
            position: relative;
            overflow: hidden;
            z-index: 50;
        }

        .project-form-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>') repeat;
            opacity: 0.3;
        }

        .steps-navigation {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 0;
            margin: 30px 0 0 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 123px;
            z-index: 98;
            overflow: hidden;
        }

        .steps-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex: 1;
        }

        .step-item {
            display: flex;
            align-items: flex-start;
            position: relative;
            flex: 1;
            max-width: 200px;
            justify-content: center;
        }

        .step-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -50%;
            top: 25px;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, #e5e7eb 0%, transparent 100%);
            z-index: 0;
        }

        .step-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
            width: 100%;
            min-height: 80px;
        }

        .step-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e5e7eb;
            color: var(--mk-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
            flex-shrink: 0;
        }

        .step-item.active .step-number {
            background: var(--mk-primary);
            color: white;
            border-color: var(--mk-primary);
            box-shadow: 0 0 0 3px rgba(109, 81, 146, 0.2);
        }

        .step-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--mk-gray);
            text-align: center;
            transition: all 0.3s ease;
            line-height: 1.2;
        }

        .step-item.active .step-label {
            color: var(--mk-primary);
            font-weight: 600;
        }

        .step-optional {
            font-size: 10px;
            color: var(--mk-gray-light);
            font-style: italic;
            margin-top: 2px;
            line-height: 1.1;
        }

        .language-switcher {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.15);
            padding: 6px;
            display: flex;
            gap: 4px;
            border: 1px solid rgba(109, 81, 146, 0.2);
            margin-right: 20px;
            flex-shrink: 0;
        }

        .lang-btn {
            background: transparent;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            color: var(--mk-gray);
            position: relative;
        }

        .lang-btn.active {
            background: var(--mk-primary);
            color: white;
        }

        .lang-btn:hover:not(.active) {
            background: var(--mk-light);
        }

        .form-steps-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            margin: 30px 0;
            min-height: 400px;
            position: relative;
        }

        .main-content-wrapper {
            padding-top: 0;
        }

        .form-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .form-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-title {
            color: var(--mk-primary);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-description {
            color: var(--mk-gray);
            margin-bottom: 30px;
            font-size: 15px;
        }

        /* NOUVEAU: Modal personnalisé pour changement de langue - SIMPLIFIÉ */
        .language-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            animation: fadeInOverlay 0.3s ease;
        }

        .language-modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .language-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            margin: 20px;
            overflow: hidden;
            transform: scale(0.9);
            animation: modalSlideIn 0.3s ease forwards;
        }

        .language-modal-header {
            background: var(--mk-gradient-primary);
            color: white;
            padding: 20px 25px;
            text-align: center;
        }

        .language-modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }

        .language-modal-body {
            padding: 30px 25px;
            text-align: center;
        }

        .language-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .language-modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .language-modal-btn-cancel {
            background: #6c757d;
            color: white;
        }

        .language-modal-btn-confirm {
            background: var(--mk-warning);
            color: white;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-label {
            font-weight: 600;
            color: var(--mk-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-label .required-indicator {
            color: var(--mk-danger);
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .form-control, .form-select {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--mk-primary);
            box-shadow: 0 0 0 0.2rem rgba(109, 81, 146, 0.15);
            outline: none;
        }

        .help-text {
            font-size: 13px;
            color: #6c757d;
            margin-top: 5px;
        }

        .translatable-field {
            position: relative;
        }

        .translatable-indicator {
            position: absolute;
            top: 8px;
            right: 10px;
            color: var(--mk-primary);
            font-size: 14px;
            z-index: 10;
        }

        .collection-container {
            border: 2px dashed #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            background: #fafbfc;
            margin-bottom: 20px;
        }

        .collection-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .collection-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-remove-item {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--mk-danger);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove-item:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .btn-add-item {
            background: var(--mk-success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add-item:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Styles pour l'upload de fichiers */
        .file-upload-area {
            border: 3px dashed #e5e7eb;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #fafbfc;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .file-upload-area:hover {
            border-color: var(--mk-primary);
            background: rgba(109, 81, 146, 0.02);
        }

        .file-upload-area.dragover {
            border-color: var(--mk-primary);
            background: rgba(109, 81, 146, 0.05);
            transform: scale(1.02);
        }

        .file-upload-icon {
            font-size: 48px;
            color: var(--mk-gray-light);
            margin-bottom: 15px;
        }

        .file-input-hidden {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            width: 1px;
            height: 1px;
        }

        .files-preview {
            margin-top: 20px;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            animation: fileSlideIn 0.3s ease;
        }

        .file-preview-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .file-preview-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .file-preview-icon {
            font-size: 24px;
            color: var(--mk-primary);
        }

        .file-preview-details {
            text-align: left;
        }

        .file-preview-name {
            font-weight: 600;
            color: var(--mk-dark);
            font-size: 14px;
            word-break: break-word;
        }

        .file-preview-size {
            font-size: 12px;
            color: var(--mk-gray);
            margin-top: 2px;
        }

        .btn-remove-file-preview {
            background: var(--mk-danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-remove-file-preview:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        @keyframes fileSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .save-button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .btn-save-project {
            background: var(--mk-gradient-primary);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-save-project:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(109, 81, 146, 0.3);
            color: white;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-cancel:hover {
            background: #5a6268;
            color: white;
            transform: translateY(-2px);
        }

        .is-invalid {
            border-color: var(--mk-danger);
            box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25);
        }

        .invalid-feedback {
            color: var(--mk-danger);
            font-size: 13px;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .steps-navigation {
                padding: 15px 10px;
                flex-direction: column;
                gap: 15px;
            }

            .steps-container {
                order: 2;
            }

            .language-switcher {
                order: 1;
                margin-right: 0;
                align-self: flex-end;
            }

            .step-label {
                font-size: 11px;
            }

            .step-number {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            .form-steps-container {
                padding: 20px;
            }

            .lang-btn {
                padding: 4px 8px;
                font-size: 11px;
            }

            .save-button-container {
                flex-direction: column;
            }

            .language-modal {
                width: 95%;
                margin: 10px;
            }

            .language-modal-body {
                padding: 25px 20px;
            }

            .language-modal-actions {
                flex-direction: column;
            }

            .language-modal-btn {
                width: 100%;
            }

            .file-upload-area {
                padding: 30px 20px;
            }
            
            .file-upload-icon {
                font-size: 36px;
            }
            
            .files-preview {
                margin: 15px -10px;
                padding: 15px;
            }
            
            .file-preview-item {
                padding: 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .file-preview-info {
                width: 100%;
            }
            
            .btn-remove-file-preview {
                align-self: flex-end;
                margin-top: 10px;
            }
        }
    </style>
{% endblock %}

{% block body %}
<!-- Modal personnalisé pour changement de langue - SIMPLIFIÉ -->
<div class="language-modal-overlay" id="languageModal">
    <div class="language-modal">
        <div class="language-modal-header">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i>
            <h3 class="language-modal-title">Changement de langue</h3>
        </div>
        <div class="language-modal-body">
            <div style="margin-bottom: 20px; color: #333; line-height: 1.6;">
                Changer de langue va réinitialiser tous les champs traduisibles. Les données saisies seront perdues.
            </div>
            <div class="language-modal-actions">
                <button class="language-modal-btn language-modal-btn-cancel" onclick="cancelLanguageChange()">
                    <i class="fas fa-times me-2"></i>
                    Annuler
                </button>
                <button class="language-modal-btn language-modal-btn-confirm" onclick="confirmLanguageChange()">
                    <i class="fas fa-check me-2"></i>
                    Continuer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Header -->
<div class="project-form-header">
    <div class="container-fluid position-relative">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="bi-folder-plus me-3"></i>
                    Nouveau Projet
                </h1>
                <p class="mb-0">Créez un nouveau projet</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ path('admin_project_index') }}" class="btn btn-outline-light">
                    <i class="bi-arrow-left me-2"></i>
                    Retour
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Navigation par étapes avec bouton de langue intégré -->
<div class="steps-navigation" id="stepsNavigation">
    <div class="scroll-indicator"></div>
    
    <div class="steps-container">
        <div class="step-item active" data-step="1">
            <button type="button" class="step-button" data-step-btn="1">
                <div class="step-number">
                    <span>1</span>
                </div>
                <div class="step-label">Identification</div>
            </button>
        </div>

        <div class="step-item" data-step="2">
            <button type="button" class="step-button" data-step-btn="2">
                <div class="step-number">
                    <span>2</span>
                </div>
                <div class="step-label">Membres</div>
                <small class="step-optional">(Optionnel)</small>
            </button>
        </div>

        <div class="step-item" data-step="3">
            <button type="button" class="step-button" data-step-btn="3">
                <div class="step-number">
                    <span>3</span>
                </div>
                <div class="step-label">Liens</div>
                <small class="step-optional">(Optionnel)</small>
            </button>
        </div>

        <div class="step-item" data-step="4">
            <button type="button" class="step-button" data-step-btn="4">
                <div class="step-number">
                    <span>4</span>
                </div>
                <div class="step-label">Pièces jointes</div>
                <small class="step-optional">(Optionnel)</small>
            </button>
        </div>
    </div>

    <!-- Bouton de langue repositionné à droite de la navigation -->
    <div class="language-switcher">
        <button class="lang-btn {{ currentLocale == 'fr' ? 'active' : '' }}" data-lang="fr" type="button">
            FR
        </button>
        <button class="lang-btn {{ currentLocale == 'en' ? 'active' : '' }}" data-lang="en" type="button">
            EN
        </button>
    </div>
</div>

<div class="container-fluid main-content-wrapper">
    {{ form_start(form, {'attr': {'id': 'projectForm', 'novalidate': 'novalidate', 'enctype': 'multipart/form-data'}}) }}
        <div class="form-steps-container">  
            
            <!-- ÉTAPE 1: IDENTIFICATION -->
            <div class="form-step active" data-step-content="1">
                <h2 class="step-title">
                    <i class="bi-card-text text-primary"></i>
                    Identification du projet
                </h2>
                <p class="step-description">
                    Renseignez les informations principales de votre projet dans la langue souhaitée
                </p>

                <div class="form-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 translatable-field">
                                <label class="form-label">
                                    Nom du projet
                                    <span class="required-indicator">*</span>
                                </label>
                                <i class="fas fa-language translatable-indicator" title="Champ traduisible"></i>
                                {{ form_widget(form.translation.name, {'attr': {'class': 'form-control', 'data-translatable': 'true', 'placeholder': 'Saisissez le nom'}}) }}
                                {{ form_help(form.translation.name) }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    Code du projet (unique)
                                    <span class="required-indicator">*</span>
                                </label>
                                {{ form_widget(form.code, {'attr': {'class': 'form-control', 'placeholder': 'Ex: PROJ-2024'}}) }}
                                {{ form_help(form.code) }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_label(form.category) }}
                                <span class="required-indicator">*</span>
                                {{ form_widget(form.category, {'attr': {'class': 'form-select'}}) }}
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_label(form.priority) }}
                                {{ form_widget(form.priority, {'attr': {'class': 'form-select'}}) }}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 translatable-field">
                        <label class="form-label">
                            Description
                            <span class="required-indicator">*</span>
                        </label>
                        <i class="fas fa-language translatable-indicator" title="Champ traduisible"></i>
                        {{ form_widget(form.translation.description, {'attr': {'class': 'form-control', 'data-translatable': 'true', 'placeholder': 'Décrivez le projet'}}) }}
                        {{ form_help(form.translation.description) }}
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form_label(form.startDate) }}
                                {{ form_widget(form.startDate, {'attr': {'class': 'form-control'}}) }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form_label(form.endDate) }}
                                {{ form_widget(form.endDate, {'attr': {'class': 'form-control'}}) }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form_label(form.budget) }}
                                {{ form_widget(form.budget, {'attr': {'class': 'form-control'}}) }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_label(form.responsible) }}
                                {{ form_widget(form.responsible, {'attr': {'class': 'form-control'}}) }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_label(form.department) }}
                                {{ form_widget(form.department, {'attr': {'class': 'form-select'}}) }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_label(form.status) }}
                                {{ form_widget(form.status, {'attr': {'class': 'form-select'}}) }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                {{ form_label(form.displayOrder) }}
                                {{ form_widget(form.displayOrder, {'attr': {'class': 'form-control'}}) }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3 d-flex align-items-end">
                                <div class="form-check form-switch">
                                    {{ form_widget(form.isActive, {'attr': {'class': 'form-check-input'}}) }}
                                    {{ form_label(form.isActive, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÉTAPE 2: MEMBRES -->
            <div class="form-step" data-step-content="2">
                <h2 class="step-title">
                    <i class="bi-people text-primary"></i>
                    Membres du projet
                </h2>
                <p class="step-description">
                    Ajoutez les membres qui participeront au projet (optionnel)
                </p>

                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="section-title">
                            <i class="bi-person-plus"></i>
                            Équipe projet
                        </h4>
                        <button type="button" class="btn-add-item" onclick="addMember()">
                            <i class="bi-plus-circle"></i>
                            Ajouter un membre
                        </button>
                    </div>

                    <div class="collection-container" id="membersCollection">
                        <!-- Les membres seront ajoutés dynamiquement ici -->
                    </div>

                    <div class="alert alert-info">
                        <i class="bi-info-circle me-2"></i>
                        Cette étape est optionnelle. Vous pourrez ajouter des membres plus tard depuis la page de modification.
                    </div>
                </div>
            </div>

            <!-- ÉTAPE 3: LIENS -->
            <div class="form-step" data-step-content="3">
                <h2 class="step-title">
                    <i class="bi-link-45deg text-primary"></i>
                    Liens et ressources
                </h2>
                <p class="step-description">
                    Ajoutez des liens vers des ressources externes liées au projet (optionnel)
                </p>

                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="section-title">
                            <i class="bi-globe"></i>
                            Liens externes
                        </h4>
                        <button type="button" class="btn-add-item" onclick="addLink()">
                            <i class="bi-plus-circle"></i>
                            Ajouter un lien
                        </button>
                    </div>

                    <div class="collection-container" id="linksCollection">
                        <!-- Les liens seront ajoutés dynamiquement ici -->
                    </div>

                    <div class="alert alert-info">
                        <i class="bi-info-circle me-2"></i>
                        Les liens permettent de référencer des ressources externes importantes pour le projet.
                    </div>
                </div>
            </div>

            <!-- ÉTAPE 4: PIÈCES JOINTES -->
            <div class="form-step" data-step-content="4">
                <h2 class="step-title">
                    <i class="bi-paperclip text-primary"></i>
                    Pièces jointes
                </h2>
                <p class="step-description">
                    Ajoutez des documents et fichiers relatifs au projet (optionnel)
                </p>

                <div class="form-section">
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <i class="bi-cloud-upload file-upload-icon"></i>
                        <h4>Ajouter des fichiers</h4>
                        <p class="text-muted">Cliquez ici pour parcourir vos fichiers ou glissez-déposez</p>
                        <button type="button" class="btn btn-outline-primary">
                            <i class="bi-folder-open me-2"></i>
                            Parcourir les fichiers
                        </button>
                        <p class="help-text mt-3">
                            Formats acceptés: PDF, Word, Excel, PowerPoint, Images, ZIP (Max 10MB par fichier)
                        </p>
                    </div>

                    <input type="file" 
                           id="fileInput" 
                           name="files[]" 
                           multiple 
                           class="file-input-hidden"
                           accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.jpg,.jpeg,.png">

                    <!-- Prévisualisation des nouveaux fichiers -->
                    <div class="files-preview" id="filesPreview" style="display: none;">
                        <h5><i class="fas fa-paperclip me-2"></i>Fichiers sélectionnés</h5>
                        <div id="filesList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons Enregistrer -->
        <div class="save-button-container">
            <a href="{{ path('admin_project_index') }}" class="btn-cancel" onclick="return confirmCancel()">
                <i class="bi-x-circle"></i>
                Annuler
            </a>
            <button type="submit" class="btn-save-project" id="btnSaveProject">
                <i class="bi-save"></i>
                Enregistrer le projet en {{ currentLocale|upper }}
            </button>
        </div>

        <!-- Champs cachés pour les collections -->
        <div style="display: none;">
            {{ form_rest(form) }}
        </div>
        
    {{ form_end(form) }}
</div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <!-- jQuery pour Select2 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // Variables globales
        let currentStep = 1;
        let currentLang = '{{ currentLocale }}';
        let memberIndex = 0;
        let linkIndex = 0;
        let hasUnsavedChanges = false;
        let pendingLanguageChange = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            setupEventListeners();
            setupFileUpload();
            trackFormChanges();
        });

        function initializeForm() {
            setLanguage(currentLang);
            updateLanguageDisplay();
        }

        function updateLanguageDisplay() {
            const saveBtn = document.getElementById('btnSaveProject');
            if (saveBtn) {
                saveBtn.innerHTML = `<i class="bi-save"></i> Enregistrer le projet en ${currentLang.toUpperCase()}`;
            }
        }

        function trackFormChanges() {
            const form = document.getElementById('projectForm');
            const inputs = form.querySelectorAll('input, textarea, select');
            
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    markAsUnsaved();
                });
                
                if (input.type === 'text' || input.type === 'email' || input.type === 'url' || input.tagName === 'TEXTAREA') {
                    input.addEventListener('input', () => {
                        markAsUnsaved();
                    });
                }
            });
        }

        function markAsUnsaved() {
            hasUnsavedChanges = true;
        }

        function markAsSaved() {
            hasUnsavedChanges = false;
        }

        // Gestion des étapes
        function goToStep(step) {
            document.querySelectorAll('[data-step]').forEach(stepItem => {
                stepItem.classList.remove('active');
            });
            
            document.querySelectorAll('[data-step-content]').forEach(stepContent => {
                stepContent.classList.remove('active');
            });

            currentStep = step;
            document.querySelector(`[data-step-content="${currentStep}"]`).classList.add('active');
            document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
        }

        function setupEventListeners() {
            // Navigation par étapes
            document.querySelectorAll('[data-step-btn]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const step = parseInt(this.dataset.stepBtn);
                    goToStep(step);
                });
            });

            // Switch de langue avec vérification du contenu traduisible
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lang = this.dataset.lang;
                    
                    if (lang !== currentLang) {
                        // Vérifier si des champs traduisibles sont remplis
                        const hasTranslatableContent = checkTranslatableContent();
                        
                        if (hasTranslatableContent) {
                            // Si du contenu est présent, montrer le modal de confirmation
                            pendingLanguageChange = lang;
                            showLanguageModal();
                        } else {
                            // Si aucun contenu traduisible, changer directement
                            switchLanguage(lang);
                        }
                    }
                });
            });

            // Soumission du formulaire
            document.getElementById('projectForm').addEventListener('submit', handleFormSubmit);

            // Avertir avant de quitter
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        }

        function checkTranslatableContent() {
            const translatableFields = document.querySelectorAll('[data-translatable="true"]');
            
            for (let field of translatableFields) {
                if (field.value && field.value.trim() !== '') {
                    return true;
                }
            }
            
            return false;
        }

        // Gestion du modal de changement de langue
        function showLanguageModal() {
            const modal = document.getElementById('languageModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideLanguageModal() {
            const modal = document.getElementById('languageModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            pendingLanguageChange = null;
        }

        function cancelLanguageChange() {
            hideLanguageModal();
        }

        function confirmLanguageChange() {
            if (pendingLanguageChange) {
                // Réinitialiser tous les champs translatables
                resetTranslatableFields();
                
                // Changer de langue
                switchLanguage(pendingLanguageChange);
                
                // Réinitialiser l'état de modification
                hasUnsavedChanges = false;
                
                hideLanguageModal();
            }
        }

        // Fermer le modal en cliquant sur l'overlay
        document.getElementById('languageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelLanguageChange();
            }
        });

        function resetTranslatableFields() {
            const translatableFields = document.querySelectorAll('[data-translatable="true"]');
            translatableFields.forEach(field => {
                field.value = '';
            });
        }

        function switchLanguage(lang) {
            if (lang === currentLang) return;
            
            setLanguage(lang);
            updateLanguageDisplay();
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('mkba_project_lang', lang);

            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
        }

        // Gestion des collections
        function addMember() {
            const collection = document.getElementById('membersCollection');
            
            const wrapper = document.createElement('div');
            wrapper.className = 'collection-item';
            wrapper.innerHTML = `
                <button type="button" class="btn-remove-item" onclick="removeMember(this)">
                    <i class="bi-trash"></i>
                </button>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Nom complet</label>
                        <input type="text" class="form-control" name="members[${memberIndex}][name]" placeholder="Nom du membre">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="members[${memberIndex}][email]" placeholder="email@example.com">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rôle</label>
                        <select class="form-select" name="members[${memberIndex}][role]">
                            <option value="">Sélectionnez un rôle</option>
                            <option value="developer">Développeur</option>
                            <option value="designer">Designer</option>
                            <option value="manager">Chef de projet</option>
                            <option value="analyst">Analyste</option>
                            <option value="tester">Testeur</option>
                            <option value="consultant">Consultant</option>
                        </select>
                    </div>
                </div>
            `;
            
            collection.appendChild(wrapper);
            memberIndex++;
            markAsUnsaved();
            trackFormChanges();
        }

        function removeMember(button) {
            button.closest('.collection-item').remove();
            markAsUnsaved();
        }

        function addLink() {
            const collection = document.getElementById('linksCollection');
            
            const wrapper = document.createElement('div');
            wrapper.className = 'collection-item';
            wrapper.innerHTML = `
                <button type="button" class="btn-remove-item" onclick="removeLink(this)">
                    <i class="bi-trash"></i>
                </button>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Titre du lien</label>
                        <input type="text" class="form-control" name="links[${linkIndex}][title]" placeholder="Titre du lien">
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">URL</label>
                        <input type="url" class="form-control" name="links[${linkIndex}][url]" placeholder="https://example.com">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" name="links[${linkIndex}][type]">
                            <option value="">Type de lien</option>
                            <option value="documentation">Documentation</option>
                            <option value="repository">Repository</option>
                            <option value="website">Site web</option>
                            <option value="api">API</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                </div>
            `;
            
            collection.appendChild(wrapper);
            linkIndex++;
            markAsUnsaved();
            trackFormChanges();
        }

        function removeLink(button) {
            button.closest('.collection-item').remove();
            markAsUnsaved();
        }

        // Gestion des fichiers
        function setupFileUpload() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');

            // Drag & drop
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                handleFileSelection(files);
            });

            // Sélection de fichiers
            fileInput.addEventListener('change', (e) => {
                handleFileSelection(e.target.files);
            });
        }

        function handleFileSelection(files) {
            if (files.length === 0) return;

            displayFilePreview(files);
            markAsUnsaved();
        }

        function displayFilePreview(files) {
            const filesPreview = document.getElementById('filesPreview');
            const filesList = document.getElementById('filesList');
            
            // Vider la liste précédente
            filesList.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                // Validation
                if (file.size > 10 * 1024 * 1024) {
                    // SUPPRIMÉ: showNotification côté client
                    return;
                }

                const allowedExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'zip', 'jpg', 'jpeg', 'png'];
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (!allowedExtensions.includes(extension)) {
                    // SUPPRIMÉ: showNotification côté client
                    return;
                }

                // Créer l'élément de prévisualisation
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                fileItem.innerHTML = `
                    <div class="file-preview-info">
                        <i class="bi-file-earmark file-preview-icon"></i>
                        <div class="file-preview-details">
                            <div class="file-preview-name">${file.name}</div>
                            <div class="file-preview-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button type="button" class="btn-remove-file-preview" onclick="removeFileFromPreview(this)">
                        <i class="bi-trash"></i>
                    </button>
                `;
                
                filesList.appendChild(fileItem);
            });
            
            if (filesList.children.length > 0) {
                filesPreview.style.display = 'block';
            }
        }

        function removeFileFromPreview(button) {
            const fileItem = button.closest('.file-preview-item');
            fileItem.remove();
            
            // Si plus de fichiers, cacher la prévisualisation
            const filesList = document.getElementById('filesList');
            if (filesList.children.length === 0) {
                document.getElementById('filesPreview').style.display = 'none';
                document.getElementById('fileInput').value = '';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Soumission du formulaire
        function handleFormSubmit(e) {
            if (!validateForm()) {
                e.preventDefault();
                return false;
            }
            
            // Ajouter la locale et les données de traduction dans des champs cachés
            const localeInput = document.createElement('input');
            localeInput.type = 'hidden';
            localeInput.name = 'locale';
            localeInput.value = currentLang;
            e.target.appendChild(localeInput);
            
            const nameField = document.querySelector('[name="project[translation][name]"]');
            const descField = document.querySelector('[name="project[translation][description]"]');
            
            const translationNameInput = document.createElement('input');
            translationNameInput.type = 'hidden';
            translationNameInput.name = 'translation[name]';
            translationNameInput.value = nameField ? nameField.value : '';
            e.target.appendChild(translationNameInput);
            
            const translationDescInput = document.createElement('input');
            translationDescInput.type = 'hidden';
            translationDescInput.name = 'translation[description]';
            translationDescInput.value = descField ? descField.value : '';
            e.target.appendChild(translationDescInput);

            markAsSaved();
            // SUPPRIMÉ: showNotification côté client - le message viendra du controller
            
            return true;
        }

        function validateForm() {
            const requiredFields = document.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                field.classList.remove('is-invalid');
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    const feedback = field.parentNode.querySelector('.invalid-feedback');
                    if (feedback) {
                        feedback.textContent = 'Ce champ est requis';
                    }
                    isValid = false;
                }
            });

            if (!isValid) {
                // SUPPRIMÉ: showNotification côté client
                const firstInvalid = document.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalid.focus();
                }
            }

            return isValid;
        }

        function confirmCancel() {
            if (hasUnsavedChanges) {
                return confirm('Vous avez des modifications non sauvegardées. Êtes-vous sûr de vouloir annuler ?');
            }
            return true;
        }

        console.log('%c🚀 Formulaire Nouveau Projet MK BA - Messages centralisés!', 'color: #6d5192; font-size: 16px; font-weight: bold;');
        console.log('✅ NOUVEAU: Messages centralisés depuis le controller');
        console.log('✅ SUPPRIMÉ: Toutes les notifications JavaScript locales');
        console.log('✅ Upload simplifié avec validation côté serveur');
    </script>
{% endblock %}